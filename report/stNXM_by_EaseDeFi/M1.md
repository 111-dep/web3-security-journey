# Oracle startup window enforces overly strict price cap causing denial-of-service during slight early appreciation

## Summary
`StNxmOracle.sanePrice()` calculates APY based on time since startTime, and rejects prices above a 50% annualized threshold. During the startup window, any slight appreciation can result in an artificially high annualized rate due to small elapsed time, causing `price()` to revert and blocking dependent flows.

## Root Cause
In [stNXM-Contracts/contracts/core/stNxmOracle.sol](https://github.com/sherlock-audit/2025-11-stnxm-by-easedefi/blob/main/stNXM-Contracts/contracts/core/stNxmOracle.sol#L45–L53):

```solidity
uint256 elapsedTime = block.timestamp - startTime;  
if (_price < 1e18) return true;  
uint256 apy = (_price - 1e18) * 31_536_000 / elapsedTime;  
return apy <= saneApy; // saneApy = 5e17 (50% per year)  
```

With a very small elapsedTime shortly after deployment, even slight price increases produce a very large computed APY, causing `price()` to revert at [stNXM-Contracts/contracts/core/stNxmOracle.sol](https://github.com/sherlock-audit/2025-11-stnxm-by-easedefi/blob/main/stNXM-Contracts/contracts/core/stNxmOracle.sol#L31–L40).

## Internal Pre-conditions
- StNxmOracle is freshly constructed so elapsedTime is small.
- A small swap moves the TWAP slightly above 1e18.

## External Pre-conditions
- Uniswap TWAP window (1800s) is advanced sufficiently to pick up the new mean tick.

## Attack Path
1. A user or system calls `price()` within minutes of deployment.
2. TWAP returns a quote slightly above 1e18.
3. `sanePrice()` computes APY with small elapsedTime, exceeds saneApy, and reverts.
Impact
4. Dependent systems (e.g., Morpho market checks) cannot fetch price, leading to denial-of-service.

## Impact
Denial-of-service for early calls to `price()`, blocking any integration that relies on the oracle. This impairs usability immediately after deployment or reinitialization, even when appreciation is trivial.

## PoC

Minimal standalone proof:

```solidity
// SPDX-License-Identifier: UNLICENSED  
pragma solidity ^0.8.26;  

import "forge-std/Test.sol";  
import {StNxmOracle} from "stNXM-Contracts/contracts/core/stNxmOracle.sol";  

contract PoC_OracleStartupSanePriceDOS is Test {  
    function testOracleStartupSanePriceDOS() public {  
        // Assume constructor sets startTime = block.timestamp  
        StNxmOracle oracle = new StNxmOracle(address(0), address(0), address(0));  
        vm.warp(block.timestamp + 60); // small elapsed time  
        // Simulate slight appreciation; sanePrice() annualizes by tiny elapsed time  
        vm.expectRevert(bytes("Price has been manipulated too high."));  
        oracle.price();  
    }  
}  
```

## Expected behavior:

`price()` reverts with "Price has been manipulated too high." when a small appreciation occurs shortly after oracle deployment.

## Mitigation

Add a startup grace period to `sanePrice()`:

```solidity
if (elapsedTime < 1 hours) return true; // configurable grace period  
```

Alternatively, clamp elapsedTime to a minimum value (e.g., `elapsedTime = max(elapsedTime, 1 days)`), or use a piecewise threshold that ramps up over time.
Expected behavior:

price() reverts with "Price has been manipulated too high." when a small appreciation occurs shortly after oracle deployment.
Mitigation
Add a startup grace period to sanePrice():
if (elapsedTime < 1 hours) return true; // configurable grace period  
Alternatively, clamp elapsedTime to a minimum value (e.g., elapsedTime = max(elapsedTime, 1 days)), or use a piecewise threshold that ramps up over time.