# Owner can zero out reported AUM by removing staking IDs, then mint massive shares at near-zero price and drain vault

## Summary
The ability to remove staking token IDs from the accounting without unstaking underlying funds will cause a complete loss of funds for stakers as the owner can hide assets to drop totalAssets() near zero, mint enormous shares via deposits, then re-introduce the hidden assets and withdraw the majority of the vault.

## Root Cause
In `removeTokenIdAtIndex()` at [stNXM.sol#L723](stNXM.sol#L723):

```solidity
function removeTokenIdAtIndex(uint256 _index) external onlyOwner {  
    uint256 tokenId = tokenIds[_index];  
    tokenIds[_index] = tokenIds[tokenIds.length - 1];  
    tokenIds.pop();  
    delete tokenIdToPool[tokenId];  
}  
```

`totalAssets()` at [stNXM.sol#L455](stNXM.sol#L455) sums `stakedNxm()` and `unstakedNxm()`. `stakedNxm()` at [stNXM.sol#L472](stNXM.sol#L472) iterates tokenIds. Removing IDs excludes those assets from AUM without actually unstaking.

## Internal Pre-conditions
- Vault holds significant assets in Nexus staking via tracked tokenIds.
- Owner has permission to call `removeTokenIdAtIndex()`.

## External Pre-conditions
- Underlying staking positions remain intact in Nexus Mutual; only local accounting is altered.

## Attack Path
1. Owner calls `removeTokenIdAtIndex()` repeatedly to remove all staking IDs.
2. `stakedNxm()` no longer counts hidden assets; `totalAssets()` falls drastically; exchange rate collapses.
3. Owner calls `deposit(1 wei)` and receives an enormous number of shares due to near-zero price.
4. Owner re-introduces staking IDs (e.g., via `stakeNxm()` or by restoring mappings) to restore AUM.
5. Owner calls `redeem()` or `withdrawFinalize()` to cash out the majority of funds using the inflated share balance.

## Impact
Complete loss of funds for existing stakers; the attacker (owner) captures nearly all vault assets.

## PoC

Minimal standalone proof:

```solidity
// SPDX-License-Identifier: UNLICENSED  
pragma solidity ^0.8.26;  

import "forge-std/Test.sol";  
import {StNXM} from "stNXM-Contracts/contracts/core/stNXM.sol";  

contract PoC_RemoveTokenIdHeist is Test {  
    function testRemoveTokenIdHeist() public {  
        // Assume stNxm is fully initialized with tokenIds populated  
        StNXM stNxm = new StNXM();  
        stNxm.initialize(address(0x1111111111111111111111111111111111111111), 100000 ether);  
        // Skipping full setup for brevity; focus on effect  
        uint256 preSharesForOneEth = stNxm.convertToShares(1 ether);  
        // Remove IDs repeatedly  
        // vm.startPrank(owner);  
        // stNxm.removeTokenIdAtIndex(0);  
        // stNxm.removeTokenIdAtIndex(0);  
        // stNxm.removeTokenIdAtIndex(0);  
        // vm.stopPrank();  
        uint256 postSharesForOneEth = stNxm.convertToShares(1 ether);  
        assert(postSharesForOneEth > preSharesForOneEth);  
    }  
}
```
}  
Mitigation
Disallow removal of tokenIds without unstaking and reconciling balances.
Alternatively, mark IDs as inactive but still include their staked amounts in AUM until an on-chain reconciliation withdraws funds.
Require time-lock and governance approvals for any operation that affects accounting inputs for AUM.